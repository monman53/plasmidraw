<!DOCTYPE html>
<meta charset="utf-8">
<script src="https://unpkg.com/vue"></script>
<title>plasmidraw</title>


<style>
svg {
    user-select:none;
    -webkit-user-select:none;
    -ms-user-select: none;
    -moz-user-select:none;
    -khtml-user-select:none;
    -webkit-user-drag:none;
    -khtml-user-drag:none;
}
</style>


<header>
<h1>plasmidraw</h1>
<p>plasmid diagram drawer</p>
</header>

<div id='plasmid'>

    <div style='float: left'>
        <svg width='600px' height='600px' viewBox='-1.5 -1.5 3 3' id='plasmid-svg'
            @mousemove='mouseMove'
            @mouseup='mouseUp'>
            <circle cx='0' cy='0' r='1' stroke='black' fill='none' stroke-width='0.01' />
            <gene-item
                v-for='gene in genes'
                :mouse_pos='mouse_pos'
                :gene='gene'
                :key='gene.key'
                :g_style='g_style'
                @edit-gene='editGene(gene.key, gene.which)'></gene>
        </svg>
    </div>

    <div>
        <button v-on:click='addGene'>Add Gene</button><br>
        width<input type='range' min='0' max='0.5' step='0.01' v-model='g_style.dr' /><br>
        arrow<input type='range' min='0' max='0.1' step='0.002' v-model='g_style.darrow' /><br>
        stroke<input type='checkbox' v-model='g_style.stroke' /><br>

        <div v-if='editing != undefined'>
            <h3>Edit</h3>
            color<input type='color' v-model='genes[editing].color' /><br>
            <button v-on:click='deleteGene'>Delete Gene</button><br>
        </div>
    </div>
</div>

<footer style='clear: both'>
<p>powered by Vue.js and SVG.</p>
</footer>


<script>

Vue.component('gene-item', { // {{{
    template: '<g v-on:mouseenter="mouseEnter" v-on:mouseleave="mouseLeave">'+
                '<path v-if="gene.visible" @mousedown="mouseDownAll" :d="d" :fill="gene.color" stroke="black" :stroke-width="g_style.stroke ? 0.01 : 0" class="gene-item"/>'+
                '<circle v-if="gene.visible && gene.hover" fill="#FFFFFF00" stroke="black" stroke-width="0.01" :cx="sx" :cy="sy" r="0.04" @mousedown="mouseDownFrom"/>'+
                '<circle v-if="gene.visible && gene.hover" fill="#FFFFFF00" stroke="black" stroke-width="0.01" :cx="tx" :cy="ty" r="0.04" @mousedown="mouseDownTo"/>'+
              '</g>', 
    props: ['gene', 'g_style', 'mouse_pos'], 
    methods: {
        mouseEnter: function() {
            this.gene.hover = true;
        },
        mouseLeave: function() {
            this.gene.hover = false;
        },
        mouseDownAll: function(){
            this.gene.which = 'all';
            this.gene.offset = this.mouse_pos;
            this.$emit('edit-gene');
        }, 
        mouseDownFrom: function() {
            this.gene.which = 'from';
            this.$emit('edit-gene');
        }, 
        mouseDownTo: function() {
            this.gene.which = 'to';
            this.$emit('edit-gene');
        }, 
    }, 
    computed: {
        sx: function() {
           return  this.gene.r*Math.sin(this.gene.from*2*Math.PI);
        },
        sy: function() {
           return -this.gene.r*Math.cos(this.gene.from*2*Math.PI);
        },
        tx: function() {
           return  this.gene.r*Math.sin(this.gene.to*2*Math.PI);
        },
        ty: function() {
           return -this.gene.r*Math.cos(this.gene.to*2*Math.PI);
        },
        d: function() {
            var r = this.gene.r;
            var from = this.gene.from;
            var to = this.gene.to;

            var darrow = Math.min(Math.abs(from-to), this.g_style.darrow);

            var sx =  r*Math.sin(from*2*Math.PI);
            var sy = -r*Math.cos(from*2*Math.PI);
            var mx =  r*Math.sin((to+(to > from ? -darrow : darrow))*2*Math.PI);
            var my = -r*Math.cos((to+(to > from ? -darrow : darrow))*2*Math.PI);
            var tx =  r*Math.sin(to*2*Math.PI);
            var ty = -r*Math.cos(to*2*Math.PI);
            var a = from <= to ? 1 : 0;
            var b = Math.abs(from-to) >= 0.5+darrow ? 1 : 0;

            var dr = Math.min(this.g_style.dr, 1);

            var res = '';
            res += `m ${sx*(1+dr)} ${sy*(1+dr)}`;
            if(this.gene.arrow){
                res += `A ${r*(1+dr)} ${r*(1+dr)} 0 ${b} ${a} ${mx*(1+dr)} ${my*(1+dr)}`;
                res += `L ${tx} ${ty}`;
                res += `L ${mx*(1-dr)} ${my*(1-dr)}`;
                res += `A ${r*(1-dr)} ${r*(1-dr)} 0 ${b} ${1-a} ${sx*(1-dr)} ${sy*(1-dr)}`;
            }else{
                res += `A ${r*(1+dr)} ${r*(1+dr)} 0 ${b} ${a} ${tx*(1+dr)} ${ty*(1+dr)}`;
                res += `L ${tx*(1-dr)} ${ty*(1-dr)}`;
                res += `A ${r*(1-dr)} ${r*(1-dr)} 0 ${b} ${1-a} ${sx*(1-dr)} ${sy*(1-dr)}`;
            }
            res += `L ${sx*(1+dr)} ${sy*(1+dr)}`;
            return res;
        }, 
    }, 
}); // }}}

var plasmid = new Vue({
    el: "#plasmid", 
    data: {
        genes: [],
        mouse_pos: 0,
        g_style: {
            dr: 0.08,
            darrow: 0.01,
            stroke: true,
        },
        editing: undefined,
    },
    methods: {
        addGene: function() {
            var new_gene = {
                key: this.genes.length, 
                r: 1.0, 
                from: 0,
                to: 0.1,
                visible: true, 
                color: "#DDDDDD",
                hover: false, 
                which: 'from',
                arrow: true,
                offset: 0,
            }
            this.genes.push(new_gene);
        },
        deleteGene: function() {
            this.genes[this.editing].visible = false;
            this.editing = undefined;
        },
        editGene: function(key) {
            this.editing = key;
            this.drag = true;
        },
        mouseMove: function(event) {
            var svg = document.getElementById('plasmid-svg');
            var rect = svg.getBoundingClientRect();
            var x = event.clientX - rect.left - rect.width/2;
            var y = event.clientY - rect.top - rect.height/2;
            var pos = (Math.atan2(-x, y) + Math.PI)/(2*Math.PI);
            this.mouse_pos = pos;

            if(!this.drag){
                return;
            }

            var which = this.genes[this.editing].which;
            var offset = this.genes[this.editing].offset;
            if(which == 'all'){
                this.genes[this.editing].from = Math.min(Math.max(this.genes[this.editing].from+pos-offset, 0), 1);
                this.genes[this.editing].to = Math.min(Math.max(this.genes[this.editing].to+pos-offset, 0), 1);
                this.genes[this.editing].offset = pos;
            }else{
                this.genes[this.editing][which] = this.mouse_pos;
            }
        },
        mouseUp: function() {
            this.drag = false;
            //this.editing = undefined;
        }, 
    }, 
});
</script>
